name: CI Pipeline



on:

Â  push:

Â  Â  branches:

Â  Â  Â  - main

Â  Â  Â  - develop

Â  pull_request:

Â  Â  branches:

Â  Â  Â  - main



jobs:

Â  backend:

Â  Â  runs-on: ubuntu-latest

Â  Â  name: Backend CI



Â  Â  steps:

Â  Â  Â  - name: Checkout Code

Â  Â  Â  Â  uses: actions/checkout@v4



Â  Â  Â  - name: Set up PHP

Â  Â  Â  Â  uses: shivammathur/setup-php@v2

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  php-version: '8.1'

Â  Â  Â  Â  Â  extensions: sqlite, pdo_sqlite

Â  Â  Â  Â  Â  tools: composer

Â  Â  Â  Â  Â  coverage: pcov



Â  Â  Â  - name: Cache Composer Dependencies

Â  Â  Â  Â  uses: actions/cache@v3

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  path: ~/.composer/cache

Â  Â  Â  Â  Â  key: ${{ runner.os }}-composer-${{ hashFiles('backend/composer.lock') }}

Â  Â  Â  Â  Â  restore-keys: |

Â  Â  Â  Â  Â  Â  ${{ runner.os }}-composer-



Â  Â  Â  - name: Install PHP Dependencies

Â  Â  Â  Â  working-directory: backend

Â  Â  Â  Â  run: composer install --no-progress --no-suggest --prefer-dist



Â  Â  Â  - name: Run PHPUnit Tests

Â  Â  Â  Â  working-directory: backend

Â  Â  Â  Â  run: |

Â  Â  Â  Â  Â  mkdir -p coverage-report-backend

Â  Â  Â  Â  Â  ./vendor/bin/phpunit --coverage-clover coverage-report-backend/clover.xml tests



Â  Â  Â  - name: Upload Backend JUnit Report

Â  Â  Â  Â  uses: actions/upload-artifact@v4

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  name: junit-report-backend

Â  Â  Â  Â  Â  path: backend/junit-report-backend.xml



Â  Â  Â  - name: Run Liquibase Migrations (SQLite)

Â  Â  Â  Â  working-directory: backend

Â  Â  Â  Â  run: |

Â  Â  Â  Â  Â  mkdir -p ../db/lib

Â  Â  Â  Â  Â  curl -L -o ../db/lib/sqlite-jdbc.jar https://repo1.maven.org/maven2/org/xerial/sqlite-jdbc/3.42.0.0/sqlite-jdbc-3.42.0.0.jar



Â  Â  Â  Â  Â  docker run --rm \

Â  Â  Â  Â  Â  Â  -v "${{ github.workspace }}/backend:/workspace" \

Â  Â  Â  Â  Â  Â  -v "${{ github.workspace }}/db/changelogs:/workspace/changelogs" \

Â  Â  Â  Â  Â  Â  -v "${{ github.workspace }}/db/lib:/workspace/lib" \

Â  Â  Â  Â  Â  Â  liquibase/liquibase \

Â  Â  Â  Â  Â  Â  --url="jdbc:sqlite:/workspace/todo.sqlite3" \

Â  Â  Â  Â  Â  Â  --changeLogFile=changelogs/db.changelog-master.xml \

Â  Â  Â  Â  Â  Â  --driver=org.sqlite.JDBC \

Â  Â  Â  Â  Â  Â  --classpath=/workspace/lib/sqlite-jdbc.jar \

Â  Â  Â  Â  Â  Â  --search-path=/workspace update



Â  Â  Â  - name: Start PHP Server

Â  Â  Â  Â  working-directory: backend

Â  Â  Â  Â  run: |

Â  Â  Â  Â  Â  php -S 127.0.0.1:8000 -t . > server.log 2>&1 &

Â  Â  Â  Â  Â  echo "Server started in background."



Â  Â  Â  - name: Wait for Server

Â  Â  Â  Â  run: |

Â  Â  Â  Â  Â  for i in {1..30}; do

Â  Â  Â  Â  Â  Â  if curl -sSf http://127.0.0.1:8000 >/dev/null; then

Â  Â  Â  Â  Â  Â  Â  echo "âœ… Server is up!"

Â  Â  Â  Â  Â  Â  Â  exit 0

Â  Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  Â  echo "Waiting for server..."

Â  Â  Â  Â  Â  Â  sleep 2

Â  Â  Â  Â  Â  done

Â  Â  Â  Â  Â  echo "âŒ Server failed to start. Dumping log:"

Â  Â  Â  Â  Â  cat backend/server.log

Â  Â  Â  Â  Â  exit 1



Â  Â  Â  - name: Install Newman (Postman CLI)

Â  Â  Â  Â  run: npm install -g newman



Â  Â  Â  - name: Run Postman Tests

Â  Â  Â  Â  run: |

Â  Â  Â  Â  Â  newman run backend/tests/postman/todo_api_collection.json \

Â  Â  Â  Â  Â  Â  -r cli,json \

Â  Â  Â  Â  Â  Â  --reporter-json-export backend/newman-results.json



Â  Â  Â  - name: Upload Newman Report

Â  Â  Â  Â  uses: actions/upload-artifact@v4

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  name: newman-report

Â  Â  Â  Â  Â  path: backend/newman-results.json



Â  Â  Â  - name: SonarCloud Scan

Â  Â  Â  Â  uses: SonarSource/sonarqube-scan-action@v5.0.0

Â  Â  Â  Â  env:

Â  Â  Â  Â  Â  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  args: >

Â  Â  Â  Â  Â  Â  -Dsonar.projectKey=viggidbest_PHP-TODO

Â  Â  Â  Â  Â  Â  -Dsonar.organization=viggidbest

Â  Â  Â  Â  Â  Â  -Dsonar.sources=backend

Â  Â  Â  Â  Â  Â  -Dsonar.tests=backend/tests

Â  Â  Â  Â  Â  Â  -Dsonar.php.coverage.reportPaths=backend/coverage-report-backend/clover.xml

Â  Â  Â  Â  Â  Â  -Dsonar.exclusions=backend/tests/**

Â  Â  Â  Â  Â  Â  -Dsonar.qualitygate.wait=true

Â  Â  Â  Â  Â  Â  -Dsonar.verbose=true
- name: Check Sonar Quality Gate

 uses: SonarSource/sonarqube-quality-gate-action@v1.1.0

 timeout-minutes: 5

Â  Â  Â  Â  env:

Â  Â  Â  Â  Â  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

Â  Â  Â  Â  Â  SONAR_HOST_URL: https://sonarcloud.io





Â  frontend:

Â  Â  runs-on: ubuntu-latest

Â  Â  name: Frontend CI



Â  Â  steps:

Â  Â  Â  - name: Checkout Code

Â  Â  Â  Â  uses: actions/checkout@v4



Â  Â  Â  - name: Set up Node.js

Â  Â  Â  Â  uses: actions/setup-node@v3

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  node-version: '21'



Â  Â  Â  - name: Cache npm Dependencies

Â  Â  Â  Â  uses: actions/cache@v3

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  path: ~/.npm

Â  Â  Â  Â  Â  key: ${{ runner.os }}-npm-${{ hashFiles('frontend/package-lock.json') }}

Â  Â  Â  Â  Â  restore-keys: |

Â  Â  Â  Â  Â  Â  ${{ runner.os }}-npm-



Â  Â  Â  - name: Install Node.js Dependencies

Â  Â  Â  Â  run: npm install --prefix frontend



Â  Â  Â  - name: Run Vue.js Tests

Â  Â  Â  Â  run: npm run test --prefix frontend



Â  Â  Â  - name: Snyk Code Scan (Frontend)

Â  Â  Â  Â  uses: snyk/actions/node@master

Â  Â  Â  Â  env:

Â  Â  Â  Â  Â  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  command: code test

Â  Â  Â  Â  Â  args: --severity-threshold=medium

Â  Â  Â  Â  Â  project: frontend



Â  Â  Â  - name: Upload Frontend Test Report

Â  Â  Â  Â  uses: actions/upload-artifact@v4

Â  Â  Â  Â  with:

Â  Â  Â  Â  Â  name: junit-report-frontend

Â  Â  Â  Â  Â  path: frontend/test-results.xml





Â  deploy_prod:

Â  Â  if: github.ref == 'refs/heads/main'

Â  Â  needs: [backend, frontend]

Â  Â  runs-on: ubuntu-latest

Â  Â  name: "Deploy to Production"

Â  Â  steps:

Â  Â  Â  - name: Deploy Placeholder

Â  Â  Â  Â  run: echo "ðŸš€ Deploying PHP-TODO to productionâ€¦"

